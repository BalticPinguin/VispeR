<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>DR_spects.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>DR_spects.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>filename: DR_spects.py</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>include  <a href="Spect.html">Spect.py</a></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">Spect</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>include  <a href="Btree.html">Btree.py</a></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">Btree</span> <span class="kn">as</span> <span class="nn">bt</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">mmap</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">os</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <h1>CHANGELOG</h1>
<p>in version 1.0:  </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>The class to calculate full Duschinsky-spectra.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">URDR_spect</span><span class="p">(</span><span class="n">Spect</span><span class="o">.</span><span class="n">Spect</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>At this point, it is the only working class including
   Duschinksy effect.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">Hartree2cm_1</span><span class="o">=</span><span class="mf">219474.63</span> 
   <span class="n">Threshold</span><span class="o">=</span><span class="mf">3e-10</span>

   <span class="n">m</span> <span class="o">=</span> <span class="mi">10</span>
   <span class="n">A</span><span class="o">=</span><span class="p">[]</span>
   <span class="n">b</span><span class="o">=</span><span class="p">[]</span>
   <span class="n">C</span><span class="o">=</span><span class="p">[]</span>
   <span class="n">d</span><span class="o">=</span><span class="p">[]</span>
   <span class="n">E</span><span class="o">=</span><span class="p">[]</span>
   <span class="n">Gamma</span> <span class="o">=</span><span class="p">[]</span>
   <span class="n">Gammap</span><span class="o">=</span><span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>In addition to the initialisation of</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Spect( see first line of code), here the number
   of modes is evaluated and the matrices/vectors
   needed for evaluation of the recursive equations are
   calculated.</p>
<p>first, initialise as done for all spectra:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;URDR&#39;</span>
      <span class="n">Spect</span><span class="o">.</span><span class="n">Spect</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>now, calculate additional quantities for the iteration:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="bp">self</span><span class="o">.</span><span class="n">GetQuants</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>get m from opt. (-&gt; number of states considered)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">modes</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">r&quot;(?&lt;=modes\=)[\d]+&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">modes</span><span class="o">!=</span><span class="p">[]:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">=</span><span class="n">modes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">def</span> <span class="nf">GetQuants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>   <span class="c1"># in atomic units. It is equivalent to 4pi^2/h f_i</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Gammap</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># for initial state</span>
      <span class="n">sqGamma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
      <span class="n">sqGammap</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
      <span class="n">unity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">))</span>

      <span class="n">TMP</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gammap</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="n">sqGammap</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">TMP</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sqGammap</span><span class="p">)</span> <span class="o">-</span><span class="n">unity</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="n">sqGammap</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">unity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">TMP</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gammap</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="n">sqGamma</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">TMP</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sqGammap</span><span class="p">)</span> <span class="o">-</span><span class="n">unity</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">=-</span><span class="mf">2.</span><span class="o">*</span><span class="n">sqGamma</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">TMP</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gammap</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">K</span><span class="p">)))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">=</span><span class="mf">4.</span><span class="o">*</span><span class="n">sqGamma</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">TMP</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sqGammap</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>This function prepares all variables according to the given</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">def</span> <span class="nf">calcspect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>options to calculate the spectrum.</p>
<p>first: resort the elements of J, K, f to make J most closely to unity</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">resort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="p">)):</span>
         <span class="n">j</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="n">k</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;-</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
           <span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">K</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resort</span><span class="p">)):</span>
         <span class="n">k</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="k">if</span> <span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span> <span class="c1">#use absolute value only.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;before truncation:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Duschinsky-Matrix:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">printMat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Displacement vector:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">printVec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">K</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>truncate only, if this really is truncation.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="p">):</span> 
         <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">K</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;heapsort&quot;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
         <span class="n">ind</span><span class="o">=</span><span class="n">index</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">]</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">K</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
         <span class="n">f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span> <span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>
         <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
         <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">=</span><span class="n">f</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>now recalculate the matrices A,C,E,...</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="bp">self</span><span class="o">.</span><span class="n">GetQuants</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;After truncation:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Duschinsky-Matrix:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">printMat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">J</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Displacement vector:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">printVec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">K</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>finally, calculate the stick spectrum in this picture</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="bp">self</span><span class="o">.</span><span class="n">spect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">FCf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states1</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">states2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Calculates the intensities including the Duschinsky-effect.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">def</span> <span class="nf">FCf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <pre><code>
</code></pre>
<p><strong>PARAMETERS:</strong><br />
   N:      Max. number of excitation quanta state considered<br />
   T:      Temperature of the system</p>
<p>All parameters are obligatory.</p>
<p><strong>RETURNS:</strong><br />
   linespectrum </p>
<p>This function calculates the overlap-integral for zero vibrations</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">def</span> <span class="nf">CalcI00</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>   
         <span class="n">Tree</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">Tree</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">K</span><span class="p">))</span>
         <span class="n">Tree</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
         <span class="n">Zero</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">K</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>correct for vibrational groundstates</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">E</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Energy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Energy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gammap</span><span class="p">)):</span>
            <span class="n">E</span><span class="o">+=.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gammap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
         <span class="n">Tree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Zero</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Energy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Energy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Hartree2cm_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>I_00 transition-probability  <a href="Btree.html#extract">Btree.py</a>
this is done using implicit side effects</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
         <span class="n">freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Hartree2cm_1</span><span class="p">)</span>
         <span class="n">initF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#needed for boltzmann-weighing</span>
         <span class="k">return</span> <span class="n">Tree</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>This is the main function calculating the intensities iteratively.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>It fills the tree L3 using the previous trees L1 and L2.
   Each tree contains all transitions with a given total sum (initial + final)
   of vibrational quanta (i).</p>
<p>Calculates the frequency of respective transition including</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">def</span> <span class="nf">freq</span><span class="p">(</span> <span class="n">E</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">,</span> <span class="n">Gammap</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>vibrational frequency</p>
<p><em>PARAMETERS:</em>
E:      energy-difference of states
Gamma:  vector of vibrational frequencies in inital state 
        (in atomic units)
Gammap: vector of vibrational frequencies in final state 
        (in atomic units)</p>
<p><em>RETURNS;</em>
frequency of respective transition</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">return</span> <span class="p">(</span><span class="n">E</span><span class="o">+</span><span class="nb">sum</span><span class="p">(</span><span class="n">Gammap</span><span class="o">-</span><span class="n">Gamma</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Hartree2cm_1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>Find first non-zero elements in first and second half of array n</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">def</span> <span class="nf">FirstNonzero</span><span class="p">(</span><span class="n">n</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">leng</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">m</span><span class="o">=</span><span class="n">leng</span><span class="o">+</span><span class="mi">1</span> <span class="c1">#this means there is no excitation in this state</span>
            <span class="n">mp</span><span class="o">=</span><span class="n">leng</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">ni</span><span class="o">=</span><span class="n">n</span><span class="p">[:</span><span class="n">leng</span><span class="p">]</span> <span class="c1">#interger division (python3-compatible)</span>
            <span class="n">nf</span><span class="o">=</span><span class="n">n</span><span class="p">[</span><span class="n">leng</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">leng</span><span class="p">):</span>
               <span class="k">if</span> <span class="n">ni</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                  <span class="n">m</span><span class="o">=</span><span class="n">j</span>
                  <span class="k">break</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">leng</span><span class="p">):</span>
               <span class="k">if</span> <span class="n">nf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                  <span class="n">mp</span><span class="o">=</span><span class="n">j</span>
                  <span class="k">break</span>
            <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">mp</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>initialize new tree</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
         <span class="n">L3</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">Tree</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
         <span class="n">L3</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
         <span class="n">States</span><span class="o">=</span><span class="n">states</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>           <span class="c1"># States are all possible</span>
         
         <span class="n">Energy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Energy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Energy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
         <span class="n">sgnE</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">Energy</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">sgnE</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">sgnE</span><span class="o">=</span><span class="mi">1</span>
         <span class="n">npsqrt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span>
         <span class="n">leng</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span> <span class="c1"># = alpha//2</span>
         <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">States</span><span class="p">:</span> <span class="c1">#for each possible state, described by n(vector)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>index of first-non-zero element of (initial, final) state</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">m</span><span class="p">,</span> <span class="n">mp</span><span class="o">=</span> <span class="n">FirstNonzero</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>if the 'first' excited state is in initial state: 
         need first iteration formula</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">m</span><span class="o">&lt;=</span><span class="n">mp</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>need first iteration-formula</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="n">n_m</span><span class="o">=</span><span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
               <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span> <span class="c1">#n[m] is at least 1</span>
               <span class="n">Ps</span><span class="o">=</span><span class="n">L2</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">n</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
               <span class="n">I_nn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Ps</span>                                     <span class="c1"># first term </span>
               <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                  <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>
                  <span class="n">Ps</span><span class="o">=</span><span class="n">L1</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">n</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                  <span class="n">I_nn</span><span class="o">+=</span><span class="n">npsqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">n_m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Ps</span>          <span class="c1"># second term</span>
                  <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
               <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                  <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>
                  <span class="n">Ps</span><span class="o">=</span><span class="n">L1</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">n</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                  <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
                  <span class="n">I_nn</span><span class="o">+=</span><span class="n">npsqrt</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">m</span><span class="p">])</span><span class="o">*</span><span class="n">Ps</span> <span class="c1"># second term</span>
   
               <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>else: need the other iteration-formula</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">else</span><span class="p">:</span> 
               <span class="n">n_m</span><span class="o">=</span><span class="n">n</span><span class="p">[</span><span class="n">mp</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span>
               <span class="n">n</span><span class="p">[</span><span class="n">mp</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>
               <span class="n">Ps</span><span class="o">=</span><span class="n">L2</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">n</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
               <span class="n">I_nn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">mp</span><span class="p">]</span><span class="o">*</span><span class="n">Ps</span>                                       <span class="c1"># first term </span>
               <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="n">mp</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                  <span class="n">n</span><span class="p">[</span><span class="n">mp</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>
                  <span class="n">Ps</span><span class="o">=</span><span class="n">L1</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">n</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                  <span class="n">I_nn</span><span class="o">+=</span><span class="n">npsqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">n_m</span><span class="o">-</span><span class="mf">1.</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">mp</span><span class="p">][</span><span class="n">mp</span><span class="p">]</span><span class="o">*</span><span class="n">Ps</span>           <span class="c1"># second term</span>
                  <span class="n">n</span><span class="p">[</span><span class="n">mp</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
               <span class="n">n</span><span class="p">[</span><span class="n">mp</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">I_nn</span><span class="o">/=</span><span class="n">npsqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">n_m</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">I_nn</span><span class="p">)</span> <span class="p">,</span><span class="s2">&quot;I_nn is not a number! I_nn:&quot;</span><span class="o">+</span>\
                                         <span class="s2">&quot; {0}</span><span class="se">\n</span><span class="s2">, n:{1}</span><span class="se">\n</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">I_nn</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>don't mess with too low intensities (&lt;1e-16)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">I_nn</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1e-8</span><span class="p">:</span> 
               <span class="n">L3</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">[</span><span class="n">I_nn</span><span class="p">,</span>\
                <span class="n">freq</span><span class="p">(</span><span class="n">sgnE</span><span class="o">*</span><span class="n">Energy</span><span class="p">,</span> <span class="n">sgnE</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">[:</span><span class="n">leng</span><span class="p">],</span>\
                             <span class="n">sgnE</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="n">leng</span><span class="p">:]),</span>\
                         <span class="n">freq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="n">leng</span><span class="p">:])])</span>
         <span class="k">return</span> <span class="n">L2</span><span class="p">,</span> <span class="n">L3</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>This function creates all possible states having a total number of n</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">def</span> <span class="nf">states</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>excitations in alpha different states</p>
<p><strong>PARAMETERS:</strong> <br />
   alpha: number of degrees of freedom<br />
   n:     number of excitations  </p>
<p><strong>RETURNS:</strong><br />
   a vector containing the states.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>needed for 'states'</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">def</span> <span class="nf">unlabeled_balls_in_labeled_boxes</span><span class="p">(</span><span class="n">balls</span><span class="p">,</span> <span class="n">box_sizes</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>These functions are part of python-package: 'combinatorics' 
(download from https://pypi.python.org/pypi/Combinatorics)
unlabeled_balls_in_labeled_boxes(balls, box_sizes): This function 
returns a generator that produces all distinct distributions of 
indistinguishable balls
among labeled boxes with specified box sizes (capacities). This is 
a generalization of the most common formulation of the problem, 
where each box is
sufficiently large to accommodate all of the balls, and is an 
important 
example of a class of combinatorics problems called 
'weak composition' problems.</p>
<p>OVERVIEW</p>
<p>This function returns a generator that produces all distinct 
distributions of
indistinguishable balls among labeled boxes with specified box sizes
(capacities).  This is a generalization of the most common 
formulation of the
problem, where each box is sufficiently large to accommodate all of the
balls, and is an important example of a class of combinatorics problems
called 'weak composition' problems.</p>
<p>CONSTRUCTOR INPUTS</p>
<p>n: the number of balls</p>
<p>box_sizes: This argument is a list of length 1 or greater.  The length of
the list corresponds to the number of boxes.  <code>box_sizes[i]</code> is a positive
integer that specifies the maximum capacity of the ith box.  If
<code>box_sizes[i]</code> equals <code>n</code> (or greater), the ith box can accommodate all <code>n</code>
balls and thus effectively has unlimited capacity.</p>
<p>ACKNOWLEDGMENT</p>
<p>I'd like to thank Chris Rebert for helping me to convert my prototype
class-based code into a generator function.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">def</span> <span class="nf">_unlabeled_balls_in_labeled_boxes</span><span class="p">(</span><span class="n">balls</span><span class="p">,</span> <span class="n">box_sizes</span><span class="p">):</span> <span class="c1">#needed for &#39;unlabeled_balls_in_labeled_boxes&#39; needed for &#39;states&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>This recursive generator function was designed to be returned by
<code>unlabeled_balls_in_labeled_boxes</code>.</p>
<p>If there are no balls, all boxes must be empty:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="k">if</span> <span class="ow">not</span> <span class="n">balls</span><span class="p">:</span>
                  <span class="k">yield</span> <span class="nb">len</span><span class="p">(</span><span class="n">box_sizes</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
            
               <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">box_sizes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>If the single available box has sufficient capacity to store the balls,
there is only one possible distribution, and we return it to the caller
via <code>yield</code>.  Otherwise, the flow of control will pass to the end of the
function, triggering a <code>StopIteration</code> exception.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                  <span class="k">if</span> <span class="n">box_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">balls</span><span class="p">:</span>
                     <span class="k">yield</span> <span class="p">(</span><span class="n">balls</span><span class="p">,)</span>
         
               <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>Iterate over the number of balls in the first box (from the maximum
possible down to zero), recursively invoking the generator to distribute
the remaining balls among the remaining boxes.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                  <span class="k">for</span> <span class="n">balls_in_first_box</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">min</span><span class="p">(</span><span class="n">balls</span><span class="p">,</span> <span class="n">box_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">):</span>
                     <span class="n">balls_in_other_boxes</span><span class="o">=</span> <span class="n">balls</span> <span class="o">-</span> <span class="n">balls_in_first_box</span>
                     <span class="k">for</span> <span class="n">distribution_other</span> <span class="ow">in</span> <span class="n">_unlabeled_balls_in_labeled_boxes</span><span class="p">(</span>
                     <span class="n">balls_in_other_boxes</span><span class="p">,</span> <span class="n">box_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">balls_in_first_box</span><span class="p">,)</span> <span class="o">+</span> <span class="n">distribution_other</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>end three alternative blocks</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>skip error-checks: balls is not integer, &lt;0 or not a non-empty list
capacity= 0
for size in box_sizes:
  capacity+= size</p>
<p>if capacity &lt; balls:
  raise ValueError("The total capacity of the boxes is less than the "
  "number of balls to be distributed.")</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      
            <span class="k">return</span> <span class="n">_unlabeled_balls_in_labeled_boxes</span><span class="p">(</span><span class="n">balls</span><span class="p">,</span> <span class="n">box_sizes</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>end def unlabeled_balls_in_labeled_boxes(balls, box_sizes)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>States=np.zeros((math.factorial(n+alpha-1)/(math.factorial(n)*
math.factorial(alpha-1)),alpha))</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">States2</span><span class="o">=</span><span class="p">[]</span>
         <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
            <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">n</span> <span class="c1">#create the needed list</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>box=CDLL('/home/tm162/bin/smallscript/unlabeled_balls.so')
for distributions in cbox.unlabeled_balls_in_labeled_boxes(c_int(n),c_int(alpha)):</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">for</span> <span class="n">distributions</span> <span class="ow">in</span> <span class="n">unlabeled_balls_in_labeled_boxes</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>States[i]=np.matrix(distributions)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">States2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distributions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">))</span> <span class="c1">#save memory!</span>
         <span class="k">return</span> <span class="n">States2</span>
   
      <span class="n">lines</span><span class="o">=</span><span class="p">[]</span>
      <span class="n">freqs</span><span class="o">=</span><span class="p">[]</span>
      <span class="n">initF</span><span class="o">=</span><span class="p">[]</span>
      <span class="n">lineapp</span><span class="o">=</span><span class="n">lines</span><span class="o">.</span><span class="n">append</span>
      <span class="n">freqapp</span><span class="o">=</span><span class="n">freqs</span><span class="o">.</span><span class="n">append</span>
      <span class="n">initapp</span><span class="o">=</span><span class="n">initF</span><span class="o">.</span><span class="n">append</span>
   
      <span class="n">L2</span><span class="o">=</span><span class="n">CalcI00</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>both trees can be considered to coincide for first state. </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">L1</span><span class="o">=</span><span class="n">L2</span> 
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
         <span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="o">=</span><span class="n">iterate</span><span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">L1</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">L2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>only by assert: MemoryError</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">break</span> <span class="c1"># kill calculation</span>
         <span class="n">spect</span><span class="o">=</span><span class="n">L2</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
         <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spect</span><span class="p">)):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>I_nn is stored; the intensity is I_nn*I_nn</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">lineapp</span><span class="p">(</span><span class="n">spect</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">spect</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  
            <span class="n">freqapp</span><span class="p">(</span><span class="n">spect</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>             <span class="c1">#energy of respective transition </span>
            <span class="n">initapp</span><span class="p">(</span><span class="n">spect</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>             <span class="c1">#for thermal population: frequency in init. state</span>
      <span class="n">result</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>print freqs</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">freqs</span>
      <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Hartree2cm_1</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>arbitrary but constant number for mode</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">42</span>
         <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">initF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">T</span><span class="p">)</span> <span class="c1">#thermally weighting of transitions</span>
      <span class="k">return</span> <span class="n">result</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>This class is not working at the moment.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">SDR_spect</span><span class="p">(</span><span class="n">Spect</span><span class="o">.</span><span class="n">Spect</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>I am not sure yet whether to enable it or through it away...</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">Hartree2cm_1</span><span class="o">=</span><span class="mf">219474.63</span> 
   <span class="n">Threshold</span><span class="o">=</span><span class="mf">3e-10</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>In addition to the initialisation of</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>Spect( see first line of code), here the number
   of modes is evaluated and the matrices/vectors
   needed for evaluation of the recursive equations are
   calculated.</p>
<p>first, initialise as done for all spectra:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;URDR&#39;</span>
      <span class="n">Spect</span><span class="o">.</span><span class="n">Spect</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>now, calculate additional quantities for the iteration:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>This class containes the functions and objects for the calculation of vibronic spectra</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">class</span> <span class="nc">OPA</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p>in Duschinski-rotated systems.
   ==OBJECTS==
   L   number of excited states (in total: initial+final)
   mat matrix containing FC-factors: first index: number of mode being excited, second index is exc. number</p>
<p>initialises the class</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span> <span class="c1">#should it be __new__?</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>alpha: number of vibrational modes
  L:     number of states excited</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">assert</span> <span class="n">alpha</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;There must be at least one degree of freedom!&quot;</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">=</span><span class="n">L</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      <p>first index in mat:number of mode, second: excitation number</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="p">,</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#change elements to some float32 or so...</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">FC</span><span class="p">):</span>
         <span class="n">exc</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
         <span class="k">if</span> <span class="n">exc</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">:])</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">exc</span><span class="p">]</span><span class="o">=</span><span class="n">FC</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">N</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">FC</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">def</span> <span class="nf">getState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span> 
         <span class="n">exc</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">:]))</span>
         <span class="k">if</span> <span class="n">exc</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">:])</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">N</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">exc</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#extract all elements </span>
         <span class="n">selfmat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span>
         <span class="n">intens</span><span class="o">=</span><span class="p">[]</span>
         <span class="n">ind</span><span class="o">=</span><span class="p">[]</span>
         <span class="n">excs</span><span class="o">=</span><span class="p">[]</span>
         <span class="n">intapp</span><span class="o">=</span><span class="n">intens</span><span class="o">.</span><span class="n">append</span>
         <span class="n">indapp</span><span class="o">=</span><span class="n">ind</span><span class="o">.</span><span class="n">append</span>
         <span class="n">excapp</span><span class="o">=</span><span class="n">excs</span><span class="o">.</span><span class="n">append</span>
         <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selfmat</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selfmat</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
               <span class="k">if</span> <span class="n">selfmat</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">exc</span><span class="p">]</span><span class="o">&gt;</span><span class="n">Threshold</span><span class="p">:</span>
                  <span class="n">intapp</span><span class="p">(</span><span class="n">selfmat</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">exc</span><span class="p">])</span>
                  <span class="n">indapp</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                  <span class="n">excapp</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
               <span class="k">elif</span> <span class="n">selfmat</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">exc</span><span class="p">]</span><span class="o">&lt;-</span><span class="n">Threshold</span><span class="p">:</span>
                  <span class="n">intapp</span><span class="p">(</span><span class="n">selfmat</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">exc</span><span class="p">])</span>
                  <span class="n">indapp</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                  <span class="n">excapp</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
   
         <span class="k">return</span> <span class="n">intens</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">excs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="c1">#I need squares as intensities</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>Calculates the FC-factors for given Duschinsky-effect. No restriction to OPA</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">def</span> <span class="nf">simpleFCfOPA</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">E0</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p><strong>PARAMETERS:</strong><br />
   J:      Duschisky-matrix<br />
   K:      Displacement-Vector<br />
   f:      frequency: two-dim array (freq_initial, freq_final)<br />
   Energy: Energy-difference of minima<br />
   N:      Max. number of excitation quanta state considered<br />
   T:      temperature of the system (in atomic units)<br />
   E0:     relative energy with respect to lowest triplet state    </p>
<p>All arguments are obligatory.  </p>
<p><strong>RETURNS:</strong><br />
   linespectrum </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      <p>This function calculates the overlap-integral for zero vibrations</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">def</span> <span class="nf">CalcI00</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">E</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">opa</span><span class="o">=</span><span class="n">OPA</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#call OPA-class, initialize object for 0-&gt;0 trasition.</span>
         <span class="n">zeros</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dim</span><span class="p">)</span>
         <span class="n">inten</span><span class="o">=</span><span class="mf">1.00</span> <span class="c1">#set intensity (scaled arbitrarily</span>
         <span class="n">opa</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">zeros</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">inten</span><span class="p">))</span> <span class="c1"># insert the intensity (transition strength)</span>
   
         <span class="n">linspect</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span><span class="n">E</span><span class="o">*</span><span class="n">Hartree2cm_1</span><span class="p">,</span> <span class="n">inten</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span> <span class="c1">#append the 0-&gt;0 transition to the linspect-array</span>
         <span class="k">return</span> <span class="n">opa</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>Calculates the Franck-Condon factors of an eletronic transition using the lower levels L1 and L2</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      <p><strong>PARAMETERS:</strong><br />
  L1:     binary tree where i-2 quanta are excited (structure:  <a href="Btree.html">Btree.py</a><br />
  L2:     binary tree where i-1 quanta are excited<br />
  Energy: Energy-difference between the states (minimal energy)<br />
  i:      number of excitation-quanta<br />
  f:      (2xN) frequencies of both states<br />
  J:      Duschisky-rotation matrix<br />
  K:      Displacement-vector  </p>
<p><strong>RETURNS:</strong><br />
  L2:     input-parameter (needed for next iteration)<br />
  L3:     new binary tree   </p>
<p>This function creates all possible states having a total number of n excitations in alpha different states</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">def</span> <span class="nf">states</span><span class="p">(</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p><strong>PARAMETERS:</strong><br />
   alpha: number of degrees of freedom<br />
   n:     number of excitations  </p>
<p><strong>RETURNS:</strong></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">States</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">distributions</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
               <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                  <span class="n">distributions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">n</span><span class="o">-</span><span class="n">j</span>
                  <span class="n">distributions</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">alpha</span><span class="p">]</span><span class="o">=</span><span class="n">j</span>
                  <span class="n">States</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distributions</span><span class="p">))</span> <span class="c1">#save memory!</span>
                  <span class="n">distributions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                  <span class="n">distributions</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">alpha</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">return</span> <span class="n">States</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      <p>initialize new OPA-object</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">leng</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
         <span class="n">L3</span><span class="o">=</span><span class="n">OPA</span><span class="p">(</span><span class="n">leng</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>                   <span class="c1"># initialize root-node</span>
         <span class="n">States</span><span class="o">=</span><span class="n">states</span><span class="p">(</span><span class="n">leng</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>           <span class="c1"># States are all possible</span>
         <span class="n">npsqrt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span>
   
         <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">States</span><span class="p">:</span> <span class="c1">#for each possible state, described by n(vector)</span>
            <span class="n">I_nn</span><span class="o">=</span><span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      <p>need first iteration formula</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">m</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">n</span><span class="p">[:</span><span class="n">leng</span><span class="p">])</span>  <span class="c1">#if there is no excitation: it returns 0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      <p>if there excists excitation in initial state: need first iteration formula</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      <p>need first iteration-formula</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="n">n_m</span><span class="o">=</span><span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
               <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span> <span class="c1">#n[m] is at least 1</span>
               <span class="n">Ps</span><span class="o">=</span><span class="n">L2</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      <p>if not math.isnan(Ps):</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="n">I_nn</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Ps</span>                                     <span class="c1"># first term </span>
               <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                  <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>
                  <span class="n">Ps</span><span class="o">=</span><span class="n">L1</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-74'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-74'>#</a>
      </div>
      <p>if not math.isnan(Ps) and abs(Ps)&gt;1e-8:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                  <span class="n">I_nn</span><span class="o">+=</span><span class="n">npsqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">n_m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Ps</span>         <span class="c1"># second termA</span>
                  <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
               <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                  <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>
                  <span class="n">Ps</span><span class="o">=</span><span class="n">L1</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                  <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-75'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-75'>#</a>
      </div>
      <p>if not math.isnan(Ps) and abs(Ps)&gt;1e-8:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                  <span class="n">I_nn</span><span class="o">+=</span><span class="n">npsqrt</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">m</span><span class="p">])</span><span class="o">*</span><span class="n">Ps</span> <span class="c1"># second term</span>
   
               <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-76'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-76'>#</a>
      </div>
      <p>else: need the other iteration-formula</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">else</span><span class="p">:</span> 
               <span class="n">m</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">leng</span><span class="p">:])</span>  <span class="c1">#if there is no excitation: it returns 0</span>
               <span class="n">n_m</span><span class="o">=</span><span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span>
               <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>
               <span class="n">Ps</span><span class="o">=</span><span class="n">L2</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
               <span class="n">I_nn</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Ps</span>                                    <span class="c1"># first term </span>
               <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                  <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>
                  <span class="n">Ps</span><span class="o">=</span><span class="n">L1</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-77'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-77'>#</a>
      </div>
      <p>if not math.isnan(Ps) and abs(Ps)&gt;1e-8:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                  <span class="n">I_nn</span><span class="o">+=</span><span class="n">npsqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">n_m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Ps</span>         <span class="c1"># second term</span>
                  <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
               <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">I_nn</span><span class="o">/=</span><span class="n">npsqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">n_m</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">I_nn</span><span class="p">)</span> <span class="p">,</span><span class="s2">&quot;I_nn is not a number! I_nn: {0}</span><span class="se">\n</span><span class="s2">, n:{1}</span><span class="se">\n</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">I_nn</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">L3</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I_nn</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">L2</span><span class="p">,</span> <span class="n">L3</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-78'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-78'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">def</span> <span class="nf">makeLine</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">intens</span><span class="p">,</span> <span class="n">E0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">,</span> <span class="n">Gammap</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-79'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-79'>#</a>
      </div>
      <p>F=np.zeros(( len(index),3 ))</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">F</span><span class="o">=</span><span class="p">[]</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)):</span>
            <span class="n">indi</span><span class="o">=</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">intens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">intens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">Gammap</span><span class="p">[</span><span class="n">indi</span><span class="p">]</span><span class="o">*</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">E0</span><span class="p">)</span><span class="o">/</span><span class="n">T</span><span class="p">)</span> <span class="o">&gt;</span><span class="n">Threshold</span><span class="p">:</span>
               <span class="n">F</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="o">*</span><span class="n">Gamma</span><span class="p">[</span><span class="n">indi</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                         <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="o">*</span><span class="n">Gammap</span><span class="p">[</span><span class="n">indi</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="n">E</span><span class="p">)</span><span class="o">*</span><span class="n">Hartree2cm_1</span><span class="p">,</span>
                        <span class="n">intens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">intens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">Gammap</span><span class="p">[</span><span class="n">indi</span><span class="p">]</span><span class="o">*</span><span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">E0</span><span class="p">)</span><span class="o">/</span><span class="n">T</span><span class="p">)</span> <span class="p">,</span>
                        <span class="mi">0</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-80'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-80'>#</a>
      </div>
      <p>if F[-1][1]&gt;0.0001:
   print index[i], ex[i], n-ex[i], F[-1][1], F[-1][0]-E*Hartree2cm_1</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   
         <span class="k">if</span> <span class="n">F</span><span class="o">==</span><span class="p">[]:</span> <span class="c1"># no transitions with enough intensity occured.</span>
            <span class="n">F</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
         <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
      
      <span class="n">dimen</span><span class="o">=</span><span class="mi">0</span>
   
      <span class="n">linspect</span><span class="o">=</span><span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-81'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-81'>#</a>
      </div>
      <p>correct for vibrational groundstates:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">Energy</span><span class="o">+=</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*.</span><span class="mi">5</span>
      <span class="n">L2</span><span class="o">=</span><span class="n">CalcI00</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">Energy</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-82'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-82'>#</a>
      </div>
      <p>this is already extracted to linspect (using side-effects)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">L1</span><span class="o">=</span><span class="n">L2</span> 
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
         <span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="o">=</span><span class="n">iterate</span><span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
         <span class="n">intens</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">excitation</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">L2</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
         <span class="n">linspect</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">makeLine</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">intens</span><span class="p">,</span> <span class="n">E0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">excitation</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
         <span class="n">dimen</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">linspect</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
      <span class="n">spect</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dimen</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
      <span class="n">spect</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">linspect</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">=</span><span class="n">linspect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">dimen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">linspect</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">linspect</span><span class="p">)):</span>
         <span class="n">spect</span><span class="p">[</span><span class="n">dimen</span><span class="p">:</span><span class="n">dimen</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">linspect</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">=</span><span class="n">linspect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
         <span class="n">dimen</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">linspect</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">spect</span><span class="o">.</span><span class="n">T</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-83'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-83'>#</a>
      </div>
      <p>Calculates the FC-factors for given Duschinsky-effect. No restriction to OPA</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">def</span> <span class="nf">resortFCfOPA</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span><span class="n">E0</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-84'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-84'>#</a>
      </div>
      <p><strong>PARAMETERS:</strong>  <br />
J:      Duschisky-matrix <br />
K:      Displacement-Vector <br />
f:      frequency: two-dim array (freq_initial, freq_final) <br />
Energy: Energy-difference of minima <br />
N:      Max. number of excitation quanta state considered <br />
T:      temperature of the system (in atomic units) <br />
E0:     relative energy with respect to lowest triplet state   </p>
<p>All arguments are obligatory.</p>
<p><strong>RETURNS:</strong> <br />
linespectrum </p>
<p>quantities for the iterative spectrum-calculation
f[0]=f[1]</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-85'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-85'>#</a>
      </div>
      <p>J=np.eye(len(f[0]))
K*=np.sqrt(np.pi)/2.  # --&gt; do it in functions_smsc.Duschinsky now.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   
      <span class="n">resort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J</span><span class="p">)):</span>
         <span class="n">j</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="n">k</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="k">if</span> <span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
            <span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
      <span class="n">J</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
      <span class="n">K</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resort</span><span class="p">)):</span>
         <span class="n">k</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="k">if</span> <span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span> <span class="c1">#use absolute value only.</span>
      <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">spect</span><span class="o">=</span><span class="n">simpleFCfOPA</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span><span class="n">E0</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">spect</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-86'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-86'>#</a>
      </div>
      <p>Calculates the FC-factors for given Duschinsky-effect. No restriction to OPA</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">def</span> <span class="nf">dist_FCfOPA</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">E0</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-87'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-87'>#</a>
      </div>
      <p><em>PARAMETERS:</em>
J:      Duschisky-matrix
K:      Displacement-Vector
f:      frequency: two-dim array (freq_initial, freq_final)
Energy: Energy-difference of minima
N:      Max. number of excitation quanta state considered
T:      temperature of the system (in atomic units)
E0:     relative energy with respect to lowest triplet state</p>
<p>All arguments are obligatory.</p>
<p><em>RETURNS:</em>
linespectrum </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   
      <span class="n">K</span><span class="o">*=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>  
         
      <span class="n">resort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J</span><span class="p">)):</span>
         <span class="n">j</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="n">k</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="k">if</span> <span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
            <span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
      <span class="n">J</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
      <span class="n">K</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resort</span><span class="p">)):</span>
         <span class="n">k</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="k">if</span> <span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">resort</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span> <span class="c1">#use absolute value only.</span>
      <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">spect2</span><span class="o">=</span><span class="p">[]</span>
      <span class="n">spect2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">simpleFCfOPA</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span><span class="n">E0</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-88'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-88'>#</a>
      </div>
      <p>print simpleFCfOPA(logging, J, K, f, Energy, N, T,E0).T</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   
      <span class="n">resort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resort</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">threshold</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">resort</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-89'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-89'>#</a>
      </div>
      <p>which is due to full OPA-scheme</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">threshold</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">resort</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
   
      <span class="n">Jo</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
      <span class="n">Ka</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
      <span class="n">f1</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">f0</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">threshold</span><span class="p">):</span>
         <span class="n">vec</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">resort</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resort</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">resort</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">resort</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
         <span class="n">resort</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">vec</span>
   
         <span class="n">J</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Jo</span><span class="p">)</span>
         <span class="n">K</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ka</span><span class="p">)</span>
         <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
         <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f0</span><span class="p">)</span>
         <span class="n">temp</span><span class="o">=</span><span class="n">simpleFCfOPA</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span><span class="n">E0</span><span class="p">)</span>
         <span class="n">spect2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">[:]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="c1"># do not take the 0-0 transititon a second time</span>
   
      <span class="n">resort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resort</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">threshold</span><span class="p">):</span>
         <span class="n">vec</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">resort</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resort</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">resort</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">resort</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
         <span class="n">resort</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">vec</span>
   
         <span class="n">J</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Jo</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
         <span class="n">K</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ka</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
         <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
         <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">resort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f0</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-90'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-90'>#</a>
      </div>
      <p>print "J", J,"\n"</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">temp</span><span class="o">=</span><span class="n">simpleFCfOPA</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span><span class="n">E0</span><span class="p">)</span>
         <span class="n">spect2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">[:]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="c1"># do not take the 0-0 transititon a second time</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-91'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-91'>#</a>
      </div>
      <p>spect2.append(temp[1:])# do not take the 0-0 transititon a second time
print (simpleFCfOPA(logging, J, K, f, Energy, N, T,E0)[:].T[1:])</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   
      <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spect2</span><span class="p">)):</span>
         <span class="n">dim</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">spect2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">spect</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
      <span class="n">leng</span><span class="o">=</span><span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spect2</span><span class="p">)):</span>
         <span class="n">spect</span><span class="p">[</span><span class="n">leng</span><span class="p">:</span><span class="n">leng</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">spect2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span><span class="o">=</span><span class="n">spect2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
         <span class="n">leng</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">spect2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
   
      <span class="k">return</span> <span class="n">spect</span><span class="o">.</span><span class="n">T</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-92'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-92'>#</a>
      </div>
      <p>version=1.0
End of DR_spects.py</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
